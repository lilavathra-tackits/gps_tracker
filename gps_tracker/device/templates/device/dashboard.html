{% extends "base.html" %}
{% block title %}Device Dashboard - {{ data.alias }}{% endblock %}
{% block content %}
<h2 class="text-2xl font-bold mb-4 text-gray-700">Dashboard for {{ data.alias }}</h2>
<p class="text-gray-600 mb-4">Device ID: {{ data.deviceId }}</p>

<!-- First Row: Speed, Battery, Compass -->
<div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-6">
    <!-- Speed -->
    <div class="bg-[#dde1e2] p-6 rounded-xl shadow-lg hover:shadow-xl transition duration-300 text-center h-full border ">
        <h3 class="text-lg font-semibold text-[#192a2d] mb-2"><i class="fa-solid fa-gauge"></i> Speed</h3>
        <canvas id="speedometer" class="mt-4 max-w-[250px] h-[200px] mx-auto"></canvas>
        <p class="text-gray-700 mt-2 text-base">Speed: 
            <span id="speedValue">
                {% if data.has_data %}
                    {{ data.speed|floatformat:1 }} km/h
                {% else %}
                    No data
                {% endif %}
            </span>
        </p>
    </div>

    <!-- Battery -->
    <div class="bg-[#dde1e2] p-6 rounded-xl shadow-lg hover:shadow-xl transition duration-300 text-center h-full border ">
        <h3 class="text-lg font-semibold text-[#192a2d] mb-2"><i class="fa-solid fa-battery-half"></i> Battery Charge</h3>
        <canvas id="batteryGauge" width="200" height="200" class="mx-auto block"></canvas>
        <p class="text-gray-700 mt-2 text-base">Battery: 
            <span id="batteryValue">
                {% if data.has_data %}
                    {{ data.charge }}%
                {% else %}
                    No data
                {% endif %}
            </span>
        </p>
    </div>

    <!-- Compass -->
    <div class="bg-[#dde1e2] p-6 rounded-xl shadow-lg hover:shadow-xl transition duration-300 text-center h-full border">
        <h3 class="text-lg font-semibold text-[#192a2d] mb-4"><i class="fa-solid fa-compass"></i> Heading</h3>
        <canvas id="compass" width="150" height="150" class="mx-auto"></canvas>
        <p class="text-gray-700 mt-2 text-base">Heading: 
            <span id="heading">
                {% if data.has_data %}
                    {{ data.heading }}¬∞
                {% else %}
                    No data
                {% endif %}
            </span>
        </p>
    </div>
</div>

<!-- Location Details -->
<div class="mt-6">
    <div class="bg-[#dde1e2] p-6 rounded-xl shadow-lg hover:shadow-xl transition duration-300 border ">
        <h3 class="text-lg font-semibold text-[#192a2d] mb-4">Location Details</h3>
        <div class="flex flex-col sm:flex-row gap-4">
            <!-- Left: Coordinates and Altitude -->
            <div class="flex-1">
                <ul class="text-sm space-y-3 text-gray-700">
                    <li class="flex items-center">
                        <i class="fas fa-map-marker-alt text-[#13af80] mr-3 text-lg"></i>
                        <span>Latitude: 
                            <span id="latitude" class="font-medium">
                                {% if data.has_data %}
                                    {{ data.location.latitude }}
                                {% else %}
                                    No data
                                {% endif %}
                            </span>
                        </span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-globe text-[#13af80] mr-3 text-lg"></i>
                        <span>Longitude: 
                            <span id="longitude" class="font-medium">
                                {% if data.has_data %}
                                    {{ data.location.longitude }}
                                {% else %}
                                    No data
                                {% endif %}
                            </span>
                        </span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-mountain text-[#13af80] mr-3 text-lg"></i>
                        <span>Altitude: 
                            <span id="altitude" class="font-medium">
                                {% if data.has_data %}
                                    {{ data.location.altitude }} m
                                {% else %}
                                    No data
                                {% endif %}
                            </span>
                        </span>
                    </li>
                </ul>
            </div>
            <!-- Right: Battery, Distance, and Heading -->
            <div class="flex-1">
                <ul class="text-sm space-y-3 text-gray-700">
                    <li class="flex items-center">
                        <i class="fas fa-battery-half text-[#13af80] mr-3 text-lg"></i>
                        <span>Battery: 
                            <span id="charge" class="font-medium">
                                {% if data.has_data %}
                                    {{ data.charge }}%
                                {% else %}
                                    No data
                                {% endif %}
                            </span>
                        </span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-road text-[#13af80] mr-3 text-lg"></i>
                        <span>Total Distance (24h): 
                            <span id="totalDistance" class="font-medium">
                                {% if data.has_data %}
                                    {{ data.total_distance|floatformat:2 }} m
                                {% else %}
                                    No data
                                {% endif %}
                            </span>
                        </span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-compass text-[#13af80] mr-3 text-lg"></i>
                        <span>Heading: 
                            <span id="locationHeading" class="font-medium">
                                {% if data.has_data %}
                                    {{ data.heading|floatformat:2 }}¬∞
                                {% else %}
                                    No data
                                {% endif %}
                            </span>
                        </span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Map Section -->
<div class="mt-8 bg-[#dde1e2] p-6 rounded-xl shadow-lg hover:shadow-xl transition duration-300 border ">
    <h2 class="text-xl sm:text-2xl font-bold text-[#192a2d] mb-4">Device Location</h2>
    <div id="map" class="h-[300px] sm:h-[400px] w-full rounded-lg"></div>
    <p class="text-center text-sm sm:text-base font-medium text-gray-700 mt-4">
        üåç Latitude: <span id="latitudeDisplay">
            {% if data.has_data %}
                {{ data.location.latitude }}
            {% else %}
                No data
            {% endif %}
        </span> |
        Longitude: <span id="longitudeDisplay">
            {% if data.has_data %}
                {{ data.location.longitude }}
            {% else %}
                No data
            {% endif %}
        </span>
    </p>
    <p class="text-red-600 font-bold mt-2 hidden text-center" id="error"></p>
    <p class="text-gray-600 italic mt-2 hidden text-center" id="loading">Fetching latest data...</p>
</div>

{% endblock %}

{% block extra_scripts %}
<style>
    #map { 
        height: 400px; 
        width: 100%; 
        border-radius: 8px; 
        background: #e5e7eb; 
        z-index: 100; /* Ensure map is below right dock, sidebar, and navbar */
    }
    canvas { 
        display: block; 
        margin: 0 auto; 
    }
    .leaflet-control { 
        z-index: 100 !important; /* Ensure zoom controls are below right dock, sidebar, and navbar */
    }
</style>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Initial Data
    const initialData = {
        charge: parseInt("{{ data.charge|default:'0' }}") || 0,
        speed: parseFloat("{{ data.speed|default:'0' }}") || 0,
        hasData: {{ data.has_data|yesno:"true,false" }},
        latitude: parseFloat("{{ data.location.latitude|default:'0' }}") || 13.0827,
        longitude: parseFloat("{{ data.location.longitude|default:'0' }}") || 80.2707,
        heading: parseFloat("{{ data.heading|default:'0' }}") || 0
    };

    // Battery Gauge
    function drawBatteryGauge(canvas, percentage) {
        if (!canvas || !canvas.getContext) return;
        const ctx = canvas.getContext("2d");
        const width = canvas.width;
        const height = canvas.height;
        const centerX = width / 2;
        const centerY = height / 2;
        const radius = Math.min(width, height) / 2 - 15;
        ctx.clearRect(0, 0, width, height);
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
        ctx.strokeStyle = "#d1d5db";
        ctx.lineWidth = 15;
        ctx.stroke();
        const endAngle = (percentage / 100) * 2 * Math.PI;
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, -Math.PI / 2, endAngle - Math.PI / 2);
        ctx.strokeStyle = percentage > 60 ? "#22c55e" : percentage > 30 ? "#facc15" : "#ef4444";
        ctx.lineWidth = 15;
        ctx.lineCap = "round";
        ctx.stroke();
        ctx.fillStyle = "#1f2937";
        ctx.font = "20px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(`${percentage}%`, centerX, centerY);
    }
    const batteryCanvas = document.getElementById("batteryGauge");
    if (batteryCanvas) {
        if (initialData.hasData) {
            drawBatteryGauge(batteryCanvas, initialData.charge);
            $('#charge').text(initialData.charge + '%');
            $('#batteryValue').text(initialData.charge + '%');
        } else {
            $('#charge').text('No data');
            $('#batteryValue').text('No data');
        }
    }

    // Speedometer Gauge
    function drawSpeedometer(canvas, speed) {
        if (!canvas || !canvas.getContext) return;
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        const maxSpeed = 200;
        const radius = Math.min(width, height) * 0.4;
        const centerX = width / 2;
        const centerY = height * 0.7;
        ctx.clearRect(0, 0, width, height);
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, Math.PI, 2 * Math.PI, false);
        ctx.lineWidth = 20;
        ctx.strokeStyle = '#d1d5db';
        ctx.stroke();
        ctx.beginPath();
        const speedAngle = Math.PI + (speed / maxSpeed) * Math.PI;
        ctx.arc(centerX, centerY, radius, Math.PI, speedAngle, false);
        ctx.lineWidth = 20;
        ctx.strokeStyle = '#13af80'; // Use secondary color for the speed arc
        ctx.stroke();
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#6b7280';
        for (let i = 0; i <= maxSpeed; i += 20) {
            const angle = Math.PI + (i / maxSpeed) * Math.PI;
            const innerRadius = radius - 10;
            const outerRadius = radius + 10;
            ctx.beginPath();
            ctx.moveTo(centerX + innerRadius * Math.cos(angle), centerY + innerRadius * Math.sin(angle));
            ctx.lineTo(centerX + outerRadius * Math.cos(angle), centerY + outerRadius * Math.sin(angle));
            ctx.stroke();
            if (i % 40 === 0) {
                const labelRadius = radius + 20;
                ctx.font = '12px Arial';
                ctx.fillStyle = '#374151';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(i, centerX + labelRadius * Math.cos(angle), centerY + labelRadius * Math.sin(angle));
            }
        }
        const needleAngle = Math.PI + (speed / maxSpeed) * Math.PI;
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.lineTo(centerX + radius * 0.9 * Math.cos(needleAngle), centerY + radius * 0.9 * Math.sin(needleAngle));
        ctx.lineWidth = 4;
        ctx.strokeStyle = '#1f2937';
        ctx.stroke();
        ctx.beginPath();
        ctx.arc(centerX, centerY, 8, 0, 2 * Math.PI);
        ctx.fillStyle = '#1f2937';
        ctx.fill();
        ctx.font = '20px Arial';
        ctx.fillStyle = '#374151';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(`${speed.toFixed(1)} km/h`, centerX, centerY + radius + 40);
    }
    const speedometerCanvas = document.getElementById("speedometer");
    if (speedometerCanvas) {
        speedometerCanvas.width = 300;
        speedometerCanvas.height = 200;
        if (initialData.hasData) {
            drawSpeedometer(speedometerCanvas, initialData.speed);
        }
    }

    // Compass
    function drawCompass(canvas, heading) {
        if (!canvas || !canvas.getContext) return;
        const ctx = canvas.getContext("2d");
        const width = canvas.width;
        const height = canvas.height;
        const centerX = width / 2;
        const centerY = height / 2;
        const radius = Math.min(width, height) / 2 - 10;
        ctx.clearRect(0, 0, width, height);
        const validHeading = !isNaN(heading) && heading >= 0 && heading < 360 ? heading : 0;
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
        ctx.fillStyle = '#ffffff';
        ctx.fill();
        ctx.strokeStyle = '#13af80'; // Use secondary color for the compass border
        ctx.lineWidth = 2;
        ctx.stroke();
        const directions = ['N', 'E', 'S', 'W'];
        for (let i = 0; i < 4; i++) {
            const angle = (i * 90) * Math.PI / 180 - Math.PI / 2;
            const x = centerX + (radius - 15) * Math.cos(angle);
            const y = centerY + (radius - 15) * Math.sin(angle);
            ctx.font = 'bold 14px Arial';
            ctx.fillStyle = '#1f2937';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(directions[i], x, y);
        }
        const angle = (validHeading - 90) * Math.PI / 180;
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.lineTo(centerX + radius * 0.85 * Math.cos(angle), centerY + radius * 0.85 * Math.sin(angle));
        ctx.strokeStyle = '#ef4444';
        ctx.lineWidth = 4;
        ctx.lineCap = 'round';
        ctx.stroke();
        ctx.beginPath();
        ctx.arc(centerX, centerY, 5, 0, 2 * Math.PI);
        ctx.fillStyle = '#1f2937';
        ctx.fill();
    }
    const compassCanvas = document.getElementById("compass");
    function resizeCompass() {
        if (compassCanvas) {
            const container = compassCanvas.parentElement;
            const size = Math.min(container.clientWidth * 0.8, 150);
            compassCanvas.width = size;
            compassCanvas.height = size;
            if (initialData.hasData) {
                drawCompass(compassCanvas, initialData.heading);
                $('#heading').text(initialData.heading + '¬∞');
                $('#locationHeading').text(initialData.heading + '¬∞');
            } else {
                drawCompass(compassCanvas, 0);
                $('#heading').text('No data');
                $('#locationHeading').text('No data');
            }
        }
    }
    resizeCompass();
    window.addEventListener('resize', resizeCompass);

    // Initialize Leaflet Map
    const mapElement = document.getElementById('map');
    if (mapElement) {
        const map = L.map('map', { zoomControl: true }).setView([initialData.latitude, initialData.longitude], 19);
        // Ensure Leaflet map's pane has a lower z-index
        map.getPane('mapPane').style.zIndex = 100;
        const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            maxZoom: 19,
            zIndex: 100
        }).addTo(map);
        let marker = null;
        if (initialData.hasData) {
            marker = L.marker([initialData.latitude, initialData.longitude]).addTo(map);
        }
        tileLayer.on('tileerror', () => {
            $('#error').text('Error loading map tiles. Please check your connection.').show();
        });

        // AJAX Polling
        (function pollData() {
            const fetchUrl = "{% url 'device_history_data' device_id=device.device_id %}";
            const errorDiv = $('#error');
            const loadingDiv = $('#loading');
            let lastTimestamp = "{{ data.timestamp|default:'' }}";
            let retryDelay = 4000;
            const maxDelay = 16000;

            function updateData() {
                $.ajax({
                    url: fetchUrl,
                    method: 'GET',
                    data: {
                        limit: 1,
                        time_threshold: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString()
                    },
                    dataType: 'json',
                    beforeSend: () => {
                        loadingDiv.show();
                        errorDiv.hide();
                    },
                    success: (data) => {
                        if (data.error) {
                            errorDiv.text(`Error: ${data.error}`).show();
                            retryDelay = Math.min(retryDelay * 2, maxDelay);
                            setTimeout(updateData, retryDelay);
                            return;
                        }
                        if (data.data_points && data.data_points.length > 0) {
                            const latest = data.data_points[0];
                            if (latest.timestamp !== lastTimestamp) {
                                lastTimestamp = latest.timestamp;
                                if (marker) {
                                    marker.setLatLng([latest.latitude, latest.longitude]);
                                } else {
                                    marker = L.marker([latest.latitude, latest.longitude]).addTo(map);
                                }
                                map.panTo([latest.latitude, latest.longitude], { animate: true, duration: 0.5 });
                                $('#latitude').text(latest.latitude);
                                $('#longitude').text(latest.longitude);
                                $('#latitudeDisplay').text(latest.latitude);
                                $('#longitudeDisplay').text(latest.longitude);
                                $('#altitude').text((latest.altitude || 0) + ' m');
                                $('#speedValue').text((latest.speed || 0).toFixed(1) + ' km/h');
                                $('#charge').text(latest.charge + '%');
                                $('#batteryValue').text(latest.charge + '%');
                                $('#totalDistance').text((data.total_distance || 0).toFixed(2) + ' m');
                                $('#heading').text((latest.heading || 0) + '¬∞');
                                $('#locationHeading').text((latest.heading || 0) + '¬∞');
                                if (speedometerCanvas) drawSpeedometer(speedometerCanvas, latest.speed || 0);
                                if (batteryCanvas) drawBatteryGauge(batteryCanvas, latest.charge || 0);
                                if (compassCanvas) drawCompass(compassCanvas, latest.heading || 0);
                            }
                        } else {
                            errorDiv.text('No data available for this device.').show();
                        }
                        retryDelay = 4000;
                        setTimeout(updateData, retryDelay);
                    },
                    error: (xhr) => {
                        errorDiv.text(`Failed to fetch data: ${xhr.statusText || 'Unknown error'}`).show();
                        retryDelay = Math.min(retryDelay * 2, maxDelay);
                        setTimeout(updateData, retryDelay);
                    },
                    complete: () => {
                        loadingDiv.hide();
                    }
                });
            }
            updateData();
        })();
    }
});
    document.addEventListener('DOMContentLoaded', () => {
      // Sidebar Toggle
      const menuToggle = document.getElementById('menu-toggle');
      const sidebar = document.getElementById('sidebar');
      if (menuToggle && sidebar) {
        menuToggle.addEventListener('click', () => {
          sidebar.classList.toggle('sidebar-hidden');
          console.log('Sidebar toggled:', sidebar.classList.contains('sidebar-hidden') ? 'Closed' : 'Open');
        });
      } else {
        console.error('Sidebar toggle elements not found:', { menuToggle, sidebar });
      }

      // Ensure sidebar is visible on desktop
      if (window.innerWidth >= 768) {
        sidebar.classList.remove('sidebar-hidden');
      }

      // Notification Toggle and Mark as Read
      const notificationToggle = document.getElementById('notification-toggle');
      const notificationDropdown = document.getElementById('notification-dropdown');
      const notificationBadge = document.getElementById('notification-badge');
      const notificationCount = {{ notifications|length|default:0 }};
      if (notificationBadge) {
        notificationBadge.textContent = Math.min(notificationCount, 5);
        notificationBadge.style.display = notificationCount > 0 ? 'flex' : 'none';
      } else {
        console.error('Notification badge element not found');
      }
      if (notificationToggle && notificationDropdown) {
        notificationToggle.addEventListener('click', (e) => {
          e.stopPropagation();
          notificationDropdown.classList.toggle('active');
          console.log('Notification dropdown toggled:', notificationDropdown.classList.contains('active') ? 'Open' : 'Closed');
        });
        document.addEventListener('click', (e) => {
          if (!notificationToggle.contains(e.target) && !notificationDropdown.contains(e.target)) {
            notificationDropdown.classList.remove('active');
          }
        });
      } else {
        console.error('Notification toggle elements not found:', { notificationToggle, notificationDropdown });
      }

      // Mark notification as read
      const notificationItems = document.querySelectorAll('.notification-item');
      notificationItems.forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const notificationId = item.getAttribute('data-id');
          $.ajax({
            url: `/devices/notifications/${notificationId}/mark-read/`,
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            success: () => {
              item.classList.add('opacity-50');
              let badgeCount = parseInt(notificationBadge.textContent) - 1;
              notificationBadge.textContent = Math.max(badgeCount, 0);
              notificationBadge.style.display = badgeCount > 0 ? 'flex' : 'none';
            },
            error: (xhr) => {
              console.error('Failed to mark notification as read:', xhr.responseText);
            }
          });
        });
      });

      // Toast Behavior
      const toasts = document.querySelectorAll('.toast');
      toasts.forEach(toast => {
        setTimeout(() => toast.classList.add('opacity-100'), 100);
        setTimeout(() => {
          toast.classList.remove('opacity-100');
          setTimeout(() => toast.remove(), 500);
        }, 3000);
        toast.querySelector('.toast-close')?.addEventListener('click', () => {
          toast.classList.remove('opacity-100');
          setTimeout(() => toast.remove(), 300);
        });
      });
    });

    function toggleMenu(id) {
      const menu = document.getElementById(id);
      if (menu) {
        menu.classList.toggle('hidden');
        console.log(`Menu ${id} toggled:`, menu.classList.contains('hidden') ? 'Closed' : 'Open');
      } else {
        console.error(`Menu element not found for ID: ${id}`);
      }
    }
  </script>
{% endblock %}