{% extends "base.html" %}
{% comment %} {% block title %}Device Data - {{ device.device_id }}{% endblock %} {% endcomment %}
{% block title %}Device Data - {{ device.alias }}{% endblock %}

{% block content %}
<div class="container mx-auto p-6">
  <h1 class="text-2xl font-bold mb-4 text-gray-700">Device Data: {{ device.alias }}</h1>
  <p class="text-gray-500 mb-8">Detailed metrics for the device</p>

  <!-- Metrics Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8 ">
    <!-- Total Distance Traveled -->
    <div class="device-card animate__animated animate__zoomIn " style="animation-delay: 0.25s;">
      <div class="inner flex flex-col justify-between">
        <span class="pricing" style="background: linear-gradient(to right, #60A5FA, #3B82F6);">
          <span class="text-black"><i class="fas fa-road"></i> Distance</span>
        </span>
        <p class="title text-black text-bold">Total Distance Traveled</p>
        <p class="info text-gray-100 mt-auto">{{ metrics.total_distance|floatformat:2 }} km</p>
      </div>
    </div>

    <!-- Average Speed -->
    <div class="device-card animate__animated animate__zoomIn" style="animation-delay: 0.50s;">
      <div class="inner flex flex-col justify-between">
        <span class="pricing" style="background: linear-gradient(to right, #4ADE80, #22C55E);">
          <span class="text-black"><i class="fas fa-tachometer-alt"></i> Speed</span>
        </span>
        <p class="title text-black">Average Speed</p>
        <p class="info text-gray-100 mt-auto">{{ metrics.average_speed|floatformat:1 }} km/h</p>
      </div>
    </div>

    <!-- Max/Min Speed -->
    <div class="device-card animate__animated animate__zoomIn" style="animation-delay: 0.75s;">
      <div class="inner flex flex-col justify-between">
        <span class="pricing" style="background: linear-gradient(to right, #FBBF24, #F59E0B);">
          <span class="text-black"><i class="fa-solid fa-chart-line"></i> Speed Range</span>
        </span>
        <p class="title text-black">Max/Min Speed</p>
        <div class="mt-auto">
          <p class="info text-gray-100">Max: {{ metrics.max_speed|floatformat:1 }} km/h</p>
          <p class="info text-gray-100">Min: {{ metrics.min_speed|floatformat:1 }} km/h</p>
        </div>
      </div>
    </div>

    <!-- Weekly Metrics -->
    <div class="device-card animate__animated animate__zoomIn" style="animation-delay: 1s;">
      <div class="inner flex flex-col justify-between">
        <span class="pricing" style="background: linear-gradient(to right, #2DD4BF, #14B8A6);">
          <span class="text-black"><i class="fas fa-calendar-week"></i> Weekly</span>
        </span>
        <p class="title text-black">Weekly Metrics </p>
        <div class="mt-auto">
          <p class="info text-gray-100">Total Distance: {{ metrics.weekly_data.total_distance|floatformat:2 }} km</p>
          <p class="info text-gray-100">Average Speed: {{ metrics.weekly_data.average_speed|floatformat:1 }} km/h</p>
        </div>
      </div>
    </div>

    <!-- Rash Driving Instances -->
    <div class="device-card animate__animated animate__zoomIn" style="animation-delay: 1.20s;">
      <div class="inner flex flex-col justify-between">
        <span class="pricing" style="background: linear-gradient(to right, #F87171, #EF4444);">
          <span class="text-black"><i class="fas fa-exclamation-triangle"></i> Alerts</span>
        </span>
        <p class="title text-black">Rash Driving</p>
        <div class="mt-auto">
          <p class="info text-gray-100">{{ metrics.rash_driving_instances }} times</p>
          <p class="info text-gray-100 text-sm">Speed > 80 km/h</p>
        </div>
      </div>
    </div>

    <!-- Vehicle On/Off Changes -->
    <div class="device-card animate__animated animate__zoomIn" style="animation-delay: 1.50s;">
      <div class="inner flex flex-col justify-between">
        <span class="pricing" style="background: linear-gradient(to right, #818CF8, #6366F1);">
          <span class="text-black"><i class="fas fa-power-off"></i> Status</span>
        </span>
        <p class="title text-black">Vehicle On/Off Changes</p>
        <p class="info text-gray-100 mt-auto">{{ metrics.vehicle_status_changes }} changes</p>
      </div>
    </div>
  </div>
</div>

<style>
.device-card {
  border-radius: 16px;
  box-shadow: 0 30px 30px -25px rgba(0, 38, 255, 0.205);
  padding: 10px;
  background-color: #fff;
  color: #697e91;
  max-width: 300px;
  width: 100%;
}

.device-card strong {
  font-weight: 600;
  color: #192a2d;
}

.device-card .inner {
  padding: 20px;
  padding-top: 40px;
  background-color: #e6f4ea;
  border-radius: 12px;
  position: relative;
  height: 200px; /* Fixed height for uniformity */
}

.device-card .pricing {
  position: absolute;
  top: 0;
  right: 0;
  border-radius: 99em 0 0 99em;
  display: flex;
  align-items: center;
  padding: 0.625em 0.75em;
  font-size: 1rem;
  font-weight: 600;
  color: #fff;
}

.device-card .pricing small {
  color: #fff;
  font-size: 0.75em;
  margin-left: 0.25em;
}

.device-card .title {
  font-weight: 600;
  font-size: 1.25rem;
}

.device-card .title + * {
  margin-top: 0.75rem;
}

.device-card .info {
  color: #697e91;
}

.device-card .info + * {
  margin-top: 0.5rem;
}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => { 
      const menuToggle = document.getElementById('menu-toggle');
      const sidebar = document.getElementById('sidebar');

      // Function to set sidebar state based on screen size
      function setSidebarState() {
        if (window.innerWidth >= 1024) {
          // Desktop (1024px and above): Sidebar open by default
          sidebar.classList.remove('sidebar-hidden');
        } else {
          // Mobile and tablet (below 1024px): Sidebar closed by default
          sidebar.classList.add('sidebar-hidden');
        }
      }

      // Set initial sidebar state on page load
      if (menuToggle && sidebar) {
        setSidebarState();

        // Toggle sidebar on button click
        menuToggle.addEventListener('click', () => {
          sidebar.classList.toggle('sidebar-hidden');
          console.log('Sidebar toggled:', sidebar.classList.contains('sidebar-hidden') ? 'Closed' : 'Open');
        });

        // Update sidebar state on window resize
        window.addEventListener('resize', setSidebarState);
      } else {
        console.error('Sidebar toggle elements not found:', { menuToggle, sidebar });
      }

      // Notification Toggle and Mark as Read
      const notificationToggle = document.getElementById('notification-toggle');
      const notificationDropdown = document.getElementById('notification-dropdown');
      const notificationBadge = document.getElementById('notification-badge');
      const notificationCount = {{ notifications|length|default:0 }};
      if (notificationBadge) {
        notificationBadge.textContent = Math.min(notificationCount, 5);
        notificationBadge.style.display = notificationCount > 0 ? 'flex' : 'none';
      } else {
        console.error('Notification badge element not found');
      }
      if (notificationToggle && notificationDropdown) {
        notificationToggle.addEventListener('click', (e) => {
          e.stopPropagation();
          notificationDropdown.classList.toggle('active');
          console.log('Notification dropdown toggled:', notificationDropdown.classList.contains('active') ? 'Open' : 'Closed');
        });
        document.addEventListener('click', (e) => {
          if (!notificationToggle.contains(e.target) && !notificationDropdown.contains(e.target)) {
            notificationDropdown.classList.remove('active');
          }
        });
      } else {
        console.error('Notification toggle elements not found:', { notificationToggle, notificationDropdown });
      }

      // Mark notification as read
      const notificationItems = document.querySelectorAll('.notification-item');
      notificationItems.forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const notificationId = item.getAttribute('data-id');
          $.ajax({
            url: `/devices/notifications/${notificationId}/mark-read/`,
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            success: () => {
              item.classList.add('opacity-50');
              let badgeCount = parseInt(notificationBadge.textContent) - 1;
              notificationBadge.textContent = Math.max(badgeCount, 0);
              notificationBadge.style.display = badgeCount > 0 ? 'flex' : 'none';
            },
            error: (xhr) => {
              console.error('Failed to mark notification as read:', xhr.responseText);
            }
          });
        });
      });

      // Toast Behavior
      const toasts = document.querySelectorAll('.toast');
      toasts.forEach(toast => {
        setTimeout(() => toast.classList.add('opacity-100'), 100);
        setTimeout(() => {
          toast.classList.remove('opacity-100');
          setTimeout(() => toast.remove(), 500);
        }, 3000);
        toast.querySelector('.toast-close')?.addEventListener('click', () => {
          toast.classList.remove('opacity-100');
          setTimeout(() => toast.remove(), 300);
        });
      });
    });

    function toggleMenu(id) {
      const menu = document.getElementById(id);
      if (menu) {
        menu.classList.toggle('hidden');
        console.log(`Menu ${id} toggled:`, menu.classList.contains('hidden') ? 'Closed' : 'Open');
      } else {
        console.error(`Menu element not found for ID: ${id}`);
      }
    }
</script>
{% endblock %}