{% extends "base.html" %}
{% block title %}Device Travel History - {{ device.device_id }}{% endblock %}
{% block content %}
<h1 class="text-3xl font-bold text-gray-700">Travel History for Device: {{ device.device_id }}</h1>
<p class="text-gray-500 mt-1">View the device's travel path over selected time periods</p>

<div class="mt-6 bg-white p-6 rounded-lg shadow-md">
    <div class="flex items-center gap-4 mb-4">
        <label for="timeFilter" class="text-lg font-semibold">Select Time Range:</label>
        <select id="timeFilter" class="border rounded-md p-2">
            <option value="1">Last 1 Hour</option>
            <option value="10">Last 10 Hours</option>
            <option value="24" selected>Last 1 Day</option>
            <option value="168">Last 1 Week</option>
        </select>
        <p class="text-gray-500 italic hidden" id="loading">Loading data...</p>
        <p class="text-red-600 font-bold hidden" id="error"></p>
    </div>

    <div id="map" class="h-[500px] w-full rounded-lg"></div>
    <div class="mt-4">
        <p class="text-gray-600">Total Distance: <span id="totalDistance">0</span> meters</p>
        <p class="text-gray-600">Data Points: <span id="dataPoints">0</span></p>
    </div>
</div>
{% endblock %}
{% block extra_scripts %}
<script>
    // Initialize Leaflet Map
    const map = L.map('map').setView([13.0827, 80.2707], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        maxZoom: 19
    }).addTo(map);
    let polyline = L.polyline([], { color: '#3B82F6', weight: 5 }).addTo(map);
    let marker = L.marker([13.0827, 80.2707]).addTo(map);

    map.on('tileerror', function(error, tile) {
        console.warn('Tile loading error:', error, tile);
        $('#error').text('Error loading map tiles.').show();
    });

    // Fetch and display travel history
    function fetchTravelHistory(hours) {
        const historyUrl = "{% url 'device_history_data' device_id=device.device_id %}";
        const timeThreshold = new Date(Date.now() - hours * 60 * 60 * 1000).toISOString();
        const errorDiv = $('#error');
        const loadingDiv = $('#loading');
        const totalDistanceSpan = $('#totalDistance');
        const dataPointsSpan = $('#dataPoints');

        $.ajax({
            url: historyUrl,
            method: 'GET',
            data: { time_threshold: timeThreshold },
            dataType: 'json',
            beforeSend: function() {
                loadingDiv.show();
                errorDiv.hide();
                polyline.setLatLngs([]);
                marker.setLatLng([13.0827, 80.2707]);
            },
            success: function(data) {
                loadingDiv.hide();
                if (data.error) {
                    errorDiv.text(`Error: ${data.error}`).show();
                    totalDistanceSpan.text('0');
                    dataPointsSpan.text('0');
                    return;
                }
                dataPointsSpan.text(data.count);
                totalDistanceSpan.text((data.total_distance || 0).toFixed(2));
                const points = data.data_points.map(point => [point.latitude, point.longitude]);
                polyline.setLatLngs(points);
                if (points.length > 0) {
                    map.fitBounds(polyline.getBounds());
                    marker.setLatLng(points[points.length - 1]);
                } else {
                    errorDiv.text('No valid coordinates available.').show();
                }
            },
            error: function(xhr) {
                loadingDiv.hide();
                errorDiv.text(`Error: ${xhr.statusText || 'Failed to fetch data'}`).show();
                totalDistanceSpan.text('0');
                dataPointsSpan.text('0');
            }
        });
    }

    // Event listeners
    $('#timeFilter').on('change', function() {
        const hours = parseInt(this.value);
        fetchTravelHistory(hours);
    });

    // Initial fetch for default time range (24 hours)
    fetchTravelHistory(24);


    document.addEventListener('DOMContentLoaded', () => {
      // Theme Toggle
      const themeToggle = document.getElementById('theme-toggle');
      const themeIcon = document.getElementById('theme-icon');
      const currentTheme = localStorage.getItem('theme') || 'light';
      if (themeIcon) {
        if (currentTheme === 'dark') {
          document.documentElement.classList.add('dark');
          themeIcon.classList.replace('fa-sun', 'fa-moon');
        }
        if (themeToggle) {
          themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            if (document.documentElement.classList.contains('dark')) {
              localStorage.setItem('theme', 'dark');
              themeIcon.classList.replace('fa-sun', 'fa-moon');
            } else {
              localStorage.setItem('theme', 'light');
              themeIcon.classList.replace('fa-moon', 'fa-sun');
            }
            console.log('Theme toggled:', document.documentElement.classList.contains('dark') ? 'Dark' : 'Light');
          });
        } else {
          console.error('Theme toggle element not found');
        }
      } else {
        console.error('Theme icon element not found');
      }

      // Sidebar Toggle
      const menuToggle = document.getElementById('menu-toggle');
      const sidebar = document.getElementById('sidebar');
      if (menuToggle && sidebar) {
        menuToggle.addEventListener('click', () => {
          sidebar.classList.toggle('sidebar-hidden');
          console.log('Sidebar toggled:', sidebar.classList.contains('sidebar-hidden') ? 'Closed' : 'Open');
        });
      } else {
        console.error('Sidebar toggle elements not found:', { menuToggle, sidebar });
      }

      // Ensure sidebar is visible on desktop
      if (window.innerWidth >= 768) {
        sidebar.classList.remove('sidebar-hidden');
      }

      // Notification Toggle and Mark as Read
      const notificationToggle = document.getElementById('notification-toggle');
      const notificationDropdown = document.getElementById('notification-dropdown');
      const notificationBadge = document.getElementById('notification-badge');
      const notificationCount = {{ notifications|length|default:0 }};
      if (notificationBadge) {
        notificationBadge.textContent = Math.min(notificationCount, 5);
        notificationBadge.style.display = notificationCount > 0 ? 'flex' : 'none';
      } else {
        console.error('Notification badge element not found');
      }
      if (notificationToggle && notificationDropdown) {
        notificationToggle.addEventListener('click', (e) => {
          e.stopPropagation();
          notificationDropdown.classList.toggle('active');
          console.log('Notification dropdown toggled:', notificationDropdown.classList.contains('active') ? 'Open' : 'Closed');
        });
        document.addEventListener('click', (e) => {
          if (!notificationToggle.contains(e.target) && !notificationDropdown.contains(e.target)) {
            notificationDropdown.classList.remove('active');
          }
        });
      } else {
        console.error('Notification toggle elements not found:', { notificationToggle, notificationDropdown });
      }

      // Mark notification as read
      const notificationItems = document.querySelectorAll('.notification-item');
      notificationItems.forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const notificationId = item.getAttribute('data-id');
          $.ajax({
            url: `/devices/notifications/${notificationId}/mark-read/`,
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            success: () => {
              item.classList.add('opacity-50');
              let badgeCount = parseInt(notificationBadge.textContent) - 1;
              notificationBadge.textContent = Math.max(badgeCount, 0);
              notificationBadge.style.display = badgeCount > 0 ? 'flex' : 'none';
            },
            error: (xhr) => {
              console.error('Failed to mark notification as read:', xhr.responseText);
            }
          });
        });
      });

      // Toast Behavior
      const toasts = document.querySelectorAll('.toast');
      toasts.forEach(toast => {
        setTimeout(() => toast.classList.add('opacity-100'), 100);
        setTimeout(() => {
          toast.classList.remove('opacity-100');
          setTimeout(() => toast.remove(), 500);
        }, 3000);
        toast.querySelector('.toast-close')?.addEventListener('click', () => {
          toast.classList.remove('opacity-100');
          setTimeout(() => toast.remove(), 300);
        });
      });
    });

    function toggleMenu(id) {
      const menu = document.getElementById(id);
      if (menu) {
        menu.classList.toggle('hidden');
        console.log(`Menu ${id} toggled:`, menu.classList.contains('hidden') ? 'Closed' : 'Open');
      } else {
        console.error(`Menu element not found for ID: ${id}`);
      }
    }

</script>
{% endblock %}
